@page "/settings/operating-schedule"
@using DockQueue.Client.ViewModels
@attribute [Authorize(Policy = "Screen:SettingsView")]
@inject OperatingScheduleViewModel VM

<h3>Horário de Funcionamento</h3>

@if (VM.IsLoading)
{
    <div class="alert alert-info">Carregando...</div>
}
else if (!string.IsNullOrEmpty(VM.Error))
{
    <div class="alert alert-danger">@VM.Error</div>
}
else
{
    <div class="card">
        <div class="card-body">
            @if (VM.Current is not null)
            {
                <p class="text-muted mb-2">
                    <small>
                        Criado em: @VM.Current.CreatedAt.ToLocalTime() |
                        Atualizado em: @VM.Current.UpdatedAt.ToLocalTime()
                    </small>
                </p>
            }

            <!-- DIAS -->
            <div class="mb-3">
                <label class="form-label d-block">Dias de operação</label>
                <div class="d-flex gap-3 flex-wrap">
                    @for (var i = 0; i < VM.Days.Count; i++)
                    {
                        var item = VM.Days[i];  // captura a referência do item
                                                <div class="form-check" @key="item.Flag">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           id="op-@i"
                                                           checked="@item.Selected"
                                                           @onchange="(e) => OnDayToggle(item, e)" />
                                                    <label class="form-check-label" for="op-@i">@item.Label</label>
                                                </div>
                    }
                </div>
            </div>

            <!-- HORÁRIOS (string) -->
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="startTime" class="form-label">Início</label>
                    <input id="startTime"
                           class="form-control"
                           type="time"
                           step="60"
                           value="@(VM.Edit.StartTime ?? string.Empty)"
                           @oninput="OnStartInput" />
                </div>

                <div class="col-md-4">
                    <label for="endTime" class="form-label">Fim</label>
                    <input id="endTime"
                           class="form-control"
                           type="time"
                           step="60"
                           value="@(VM.Edit.EndTime ?? string.Empty)"
                           @oninput="OnEndInput" />
                </div>

                <div class="col-md-4">
                    <label for="tz" class="form-label">Time Zone</label>
                    <input id="tz"
                           class="form-control"
                           type="text"
                           value="@(VM.Edit.TimeZone ?? string.Empty)"
                           @oninput="OnTzInput" disabled />
                    <div class="form-text">Ex.: America/Sao_Paulo</div>
                </div>
            </div>

            <div class="mt-4 d-flex gap-2">
                @if (VM.CanEdit)
                {
                    <button class="btn btn-primary" @onclick="Save" disabled="@VM.IsLoading">Salvar</button>
                }
                else
                {
                    <button class="btn btn-primary" disabled title="Você não tem permissão para editar">Salvar</button>
                }
                <button class="btn btn-outline-secondary" @onclick="Reload" disabled="@VM.IsLoading">Recarregar</button>
            </div>
        </div>
    </div>
}

@code {
    protected override async Task OnInitializedAsync() => await VM.LoadAsync();

    private async Task Save() => await VM.SaveAsync();
    private async Task Reload() => await VM.LoadAsync();

    // Handlers para evitar aspas dentro de atributos
    private void OnStartInput(ChangeEventArgs e) => VM.Edit.StartTime = e.Value?.ToString();
    private void OnEndInput(ChangeEventArgs e) => VM.Edit.EndTime = e.Value?.ToString();
    private void OnTzInput(ChangeEventArgs e) => VM.Edit.TimeZone = e.Value?.ToString() ?? string.Empty;

    private void OnDayToggle(OperatingScheduleViewModel.DayItem item, ChangeEventArgs e)
    {
        item.Selected = e.Value is bool b && b;
    }
}
