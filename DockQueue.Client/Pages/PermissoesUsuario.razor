@page "/permissoes-usuario"
@inject SweetAlertService Swal
@inject NavigationManager Nav
@inject UserService UserService
@using DockQueue.Client.Services
@using DockQueue.Application.DTOs
@using Microsoft.AspNetCore.Components
@attribute [Authorize(Policy = "Screen:PermissionsView")]


<div class="container-fluid mt-3">
	<div class="card custom-card">
		<div class="card-header">
			<div class="card-title">Permissões de Usuário</div>
		</div>
		<div class="card-body">
			<div class="mb-3 d-flex justify-content-between align-items-center">
				<div class="input-group" style="max-width: 420px;">
					<span class="input-group-text">Buscar</span>
					<input class="form-control" placeholder="Nome ou e-mail" @bind="searchTerm" @bind:event="oninput" />
				</div>
				<button class="btn btn-outline-secondary" @onclick="Reload">Recarregar</button>
			</div>
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>Nome</th>
							<th>E-mail</th>
							<th>Status</th>
							<th class="text-end">Ações</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var u in FilteredUsers)
						{
							<tr>
								<td>@u.Name</td>
								<td>@u.Email</td>
								<td>
									<span class="badge bg-info">@u.Role</span>
								</td>
								<td class="text-end">
									<button class="btn btn-sm btn-primary" @onclick="() => Edit(u.Id)">Editar</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
			@if (!FilteredUsers.Any())
			{
				<div class="text-muted">Nenhum usuário encontrado.</div>
			}
		</div>
	</div>
</div>

@code {
	private List<UserDto> users = new();
	private string? searchTerm;

	private IEnumerable<UserDto> FilteredUsers => string.IsNullOrWhiteSpace(searchTerm)
		? users
		: users.Where(u => (u.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
			|| (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

	protected override async Task OnInitializedAsync()
	{
		try
		{
			await LoadAsync();
		}
		catch (UnauthorizedAccessException)
		{
			// se a API disse 401, manda pro login
			Nav.NavigateTo("/login", true);
		}
	}


	private async Task LoadAsync()
	{
		users = await UserService.GetAllAsync();
	}

	private Task Reload()
	{
		return LoadAsync();
	}

	private void Edit(int id)
	{
		Nav.NavigateTo($"/permissoes-usuario/editar/{id}");
	}
}