@page "/permissoes-usuario/editar/{id:guid}"
@inject SweetAlertService Swal
@inject NavigationManager Nav
@inject UserPermissionsService PermissionService
@inject UsersService UserService
@using DockQueue.Client.Services.UI
@using Microsoft.AspNetCore.Components

<div class="container-fluid mt-3">
	<div class="card custom-card">
		<div class="card-header d-flex justify-content-between align-items-center">
			<div class="card-title">Permissões: @userName</div>
			<button class="btn btn-outline-secondary" @onclick="GoBack">Voltar</button>
		</div>
		<div class="card-body">
			<ul class="nav nav-tabs mb-3">
				<li class="nav-item">
					<button class="nav-link @(activeTab == Tab.Status ? "active" : null)" @onclick="(() => SetTab(Tab.Status))">Status</button>
				</li>
				<li class="nav-item">
					<button class="nav-link @(activeTab == Tab.Boxes ? "active" : null)" @onclick="(() => SetTab(Tab.Boxes))">Boxes</button>
				</li>
				<li class="nav-item">
					<button class="nav-link @(activeTab == Tab.Visualizacao ? "active" : null)" @onclick="(() => SetTab(Tab.Visualizacao))">Visualização</button>
				</li>
			</ul>

			@if (activeTab == Tab.Status)
			{
				<div>
					<div class="mb-2 text-muted">Quais status o usuário pode atribuir aos motoristas:</div>
					<div class="row g-2">
						@foreach (var s in allDriverStatuses)
						{
							<div class="col-12 col-md-6 col-lg-4">
								<div class="form-check">
								<input class="form-check-input" type="checkbox" checked="@selectedStatuses.Contains(s.Key)" @onchange="(ChangeEventArgs e) => ToggleStatus(s, (bool)e.Value!)" id="status_@s.Key" />
									<label class="form-check-label" for="status_@s.Key">@s.Name</label>
								</div>
							</div>
						}
					</div>
				</div>
			}

			@if (activeTab == Tab.Boxes)
			{
				<div>
					<div class="mb-2 text-muted">Selecione as docas (1 a 10) que o usuário pode operar:</div>
					<div class="row g-2">
						@foreach (var b in boxes)
						{
							<div class="col-6 col-md-3 col-lg-2">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" checked="@selectedBoxes.Contains(b)" @onchange="(ChangeEventArgs e) => ToggleBox(b, (bool)e.Value!)" id="box_@b" />
									<label class="form-check-label" for="box_@b">Box @b</label>
								</div>
							</div>
						}
					</div>
				</div>
			}

			@if (activeTab == Tab.Visualizacao)
			{
				<div>
					<div class="mb-2 text-muted">Selecione as telas que o usuário pode acessar:</div>
					<div class="row g-2">
						@foreach (var v in allViews)
						{
							<div class="col-12 col-md-6 col-lg-4">
								<div class="form-check">
									<input class="form-check-input" type="checkbox" checked="@selectedViews.Contains(v.Key)" @onchange="(ChangeEventArgs e) => ToggleView(v.Key, (bool)e.Value!)" id="view_@v.Key" />
									<label class="form-check-label" for="view_@v.Key">@v.Name</label>
								</div>
							</div>
						}
					</div>
				</div>
			}

			<div class="mt-3 d-flex justify-content-end">
				<button class="btn btn-primary" @onclick="Save">Salvar</button>
			</div>
		</div>
	</div>
</div>

@code {
	[Parameter] public Guid id { get; set; }

	private string userName = string.Empty;
	private Tab activeTab = Tab.Status;

	private List<DriverStatusItem> allDriverStatuses = new();
	private HashSet<string> selectedStatuses = new(StringComparer.OrdinalIgnoreCase);

	private List<int> boxes = Enumerable.Range(1, 10).ToList();
	private HashSet<int> selectedBoxes = new();

	private List<ViewItem> allViews = new();
	private HashSet<string> selectedViews = new(StringComparer.OrdinalIgnoreCase);

	protected override async Task OnInitializedAsync()
	{
		var user = await UserService.GetUserAsync(id);
		userName = user?.Name ?? "Usuário";

		allDriverStatuses = await PermissionService.GetAllDriverStatusesAsync();
		allViews = await PermissionService.GetAllViewsAsync();

		var current = await PermissionService.GetUserPermissionsAsync(id);
		selectedStatuses = new HashSet<string>(current.StatusKeys, StringComparer.OrdinalIgnoreCase);
		selectedBoxes = new HashSet<int>(current.Boxes);
		selectedViews = new HashSet<string>(current.ViewKeys, StringComparer.OrdinalIgnoreCase);
	}

	private void SetTab(Tab t) => activeTab = t;

	private void ToggleStatus(DriverStatusItem status, bool isChecked)
	{
		if (isChecked) selectedStatuses.Add(status.Key); else selectedStatuses.Remove(status.Key);
	}

	private void ToggleBox(int box, bool isChecked)
	{
		if (isChecked) selectedBoxes.Add(box); else selectedBoxes.Remove(box);
	}

	private void ToggleView(string key, bool isChecked)
	{
		if (isChecked) selectedViews.Add(key); else selectedViews.Remove(key);
	}

	private async Task Save()
	{
		var dto = new UserPermissionsUpdate
		{
			UserId = id,
			StatusKeys = selectedStatuses.ToList(),
			Boxes = selectedBoxes.OrderBy(x => x).ToList(),
			ViewKeys = selectedViews.ToList()
		};

		await PermissionService.SaveUserPermissionsAsync(dto);
		await Swal.FireAsync("Sucesso", "Permissões salvas com sucesso.", "success");
	}

	private void GoBack() => Nav.NavigateTo("/permissoes-usuario");

    public enum Tab
    {
        Status, 
        Boxes, 
        Visualizacao
    }
}