@page "/permissoes-usuario"
@inject SweetAlertService Swal
@inject NavigationManager Nav
@inject UserService UserService
@using DockQueue.Client.Services
@using DockQueue.Application.DTOs
@using Microsoft.AspNetCore.Components
@attribute [Authorize(Policy = "Screen:PermissionsView")]


<div class="container-fluid mt-3">
	<div class="card custom-card">
		<div class="card-header d-flex justify-content-between align-items-center">
			<div class="card-title m-0">Permissões dos Usuários</div>
			<div class="d-flex gap-2">
				<button class="btn btn-outline-secondary" @onclick="Reload">Recarregar</button>
			</div>
		</div>
		<div class="card-body">
	
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>Nome</th>
							<th>E-mail</th>
							<th>Função</th>
							<th class="text-end">Ações</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var u in FilteredUsers)
						{
							<tr>
								<td>@u.Name</td>
								<td>@u.Email</td>
								<td>
									<span class="badge bg-success">@u.Role</span>
								</td>
								<td class="text-end">
									<button class="btn btn-sm btn-outline-primary" @onclick="() => Edit(u.Id)">Editar</button>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
			@if (!FilteredUsers.Any())
			{
				<div class="text-muted">Nenhum usuário encontrado.</div>
			}
		</div>
	</div>
</div>

@code {
	private List<UserDto> users = new();
	private string? searchTerm;

	private IEnumerable<UserDto> FilteredUsers => string.IsNullOrWhiteSpace(searchTerm)
		? users
		: users.Where(u => (u.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
			|| (u.Email?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

	protected override async Task OnInitializedAsync()
	{
		try
		{
			await LoadAsync();
		}
		catch (UnauthorizedAccessException)
		{
			// se a API disse 401, manda pro login
			Nav.NavigateTo("/login", true);
		}
	}


	private async Task LoadAsync()
	{
		users = await UserService.GetAllAsync();
	}

	private Task Reload()
	{
		return LoadAsync();
	}

	private void Edit(int id)
	{
		Nav.NavigateTo($"/permissoes-usuario/editar/{id}");
	}
}