@page "/filas"
@using System.Linq
@using DockQueue.Domain.Enums
@using DockQueue.Application.DTOs
@using DockQueue.Client.ViewModels
@using DockQueue.Client.Services.UI
@inject QueueViewModel VM
@inject SweetAlertService Swal
@inject IJSRuntime JSRuntime

<PageTitle>Filas</PageTitle>

<div class="mb-3">
    <ul class="nav nav-pills">
        <li class="nav-item">
            <button class="nav-link @(VM.ActiveType == QueueType.Unloading ? "active" : "")"
                    @onclick="() => ChangeType(QueueType.Unloading)">
                Descarregamento
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(VM.ActiveType == QueueType.Loading ? "active" : "")"
                    @onclick="() => ChangeType(QueueType.Loading)">
                Carregamento
            </button>
        </li>
        <button class="btn btn-sm btn-danger ms-3"
                @onclick="OnClearQueue">
            Limpar
        </button>
    </ul>
</div>

@if (VM.IsLoading)
{
    <div class="d-flex align-items-center gap-2 mb-3">
        <div class="spinner-border" role="status"></div>
        <strong>Carregando...</strong>
    </div>
}
else if (!string.IsNullOrEmpty(VM.Error))
{
    <div class="alert alert-danger" role="alert">@VM.Error</div>
}
else if (VM.Entries.Count == 0)
{
    <div class="text-muted">Nenhum motorista na fila atual.</div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Posição</th>
                <th>Motorista</th>
                <th>Documento</th>
                <th>Placa</th>
                <th>Status atual</th>
                <th>Box atual</th>
                <th>Entrada</th>
                <th style="width: 200px;">Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in VM.Entries)
            {
                <tr>
                    <td>@entry.Position</td>
                    <td>@entry.DriverName</td>
                    <td>@entry.DocumentNumber</td>
                    <td>@entry.VehiclePlate</td>
                    <td>@entry.StatusName</td>
                    <td>@(entry.BoxName ?? "SEM BOX")</td>
                    <td>@entry.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-primary"
                                    @onclick="() => OpenMoveModal(entry)">
                                Movimentar
                            </button>
                            @if (entry.BoxId.HasValue)
                            {
                                @if (entry.BoxInOperation == true)
                                {
                                    <button class="btn btn-sm btn-danger" @onclick="() => OnFinishBoxOperation(entry.Id)"title="Finalizar operação no box">
                                        ⏹ Finalizar
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-success"@onclick="() => OnStartBoxOperation(entry.Id)"title="Iniciar operação no box">
                                        ▶ Iniciar
                                    </button>
                                }
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<div class="modal fade" id="moveModal" tabindex="-1" aria-labelledby="moveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moveModalLabel">Movimentar na Fila</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="CancelMove"></button>
            </div>
            <div class="modal-body">
                @if (currentEntry != null)
                {
                    <div class="mb-3">
                        <strong>Motorista:</strong> @currentEntry.DriverName<br />
                        <strong>Documento:</strong> @currentEntry.DocumentNumber<br />
                        <strong>Placa:</strong> @currentEntry.VehiclePlate<br />
                        <strong>Status Atual:</strong> @currentEntry.StatusName
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Novo Status</label>
                        <select class="form-select" @bind="movingStatusId" @bind:after="OnStatusChanged">
                            @foreach (var status in VM.Statuses)
                            {
                                <option value="@status.Id">
                                    @status.Name
                                </option>
                            }
                        </select>
                    </div>

                    @if (IsTerminalStatus(movingStatusId))
                    {
                        <div class="mb-3">
                            <label class="form-label">Box</label>
                            <select class="form-select" @bind="selectedBoxId" @bind:after="OnBoxChanged">
                                <option value="0">Selecione um box (opcional)</option>
                                @foreach (var box in GetAvailableBoxes())
                                {
                                    <option value="@box.Id">
                                        @box.Name
                                    </option>
                                }
                            </select>
                        </div>
                    }
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CancelMove">Cancelar</button>
                <button type="button" class="btn btn-primary" @onclick="ConfirmMove">
                    Confirmar Movimentação
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private int? movingEntryId;
    private int movingStatusId;
    private int? movingBoxId;
    private int selectedBoxId = 0;
    private QueueEntryViewDto? currentEntry;

    protected override async Task OnInitializedAsync()
    {
        await VM.InitAsync();
    }

    private async Task ChangeType(QueueType type)
    {
        await VM.ChangeTypeAsync(type);
        CancelMove(); // limpa movimentação ao trocar de aba
        StateHasChanged();
    }

    private async Task OpenMoveModal(QueueEntryViewDto entry)
    {
        currentEntry = entry;
        movingEntryId = entry.Id;
        movingStatusId = entry.StatusId;
        movingBoxId = entry.BoxId;
        selectedBoxId = entry.BoxId ?? 0;
        
        StateHasChanged();
        
        await JSRuntime.InvokeVoidAsync("eval", 
            "var modalElement = document.getElementById('moveModal'); " +
            "var modal = new bootstrap.Modal(modalElement); " +
            "modal.show();");
    }

    private void OnStatusChanged()
    {
        // Sempre limpa o box ao trocar o status
        movingBoxId = null;
        selectedBoxId = 0;
        StateHasChanged();
    }

    private void OnBoxChanged()
    {
        movingBoxId = selectedBoxId > 0 ? selectedBoxId : null;
    }

    private void CancelMove()
    {
        currentEntry = null;
        movingEntryId = null;
        movingStatusId = 0;
        movingBoxId = null;
        selectedBoxId = 0;
    }

    private async Task ConfirmMove()
    {
        if (movingEntryId is null)
            return;

        movingBoxId = selectedBoxId > 0 ? selectedBoxId : null;

        // Valida se o box selecionado está disponível
        if (movingBoxId.HasValue && currentEntry != null)
        {
            var selectedBox = VM.Boxes.FirstOrDefault(b => b.Id == movingBoxId.Value);
            if (selectedBox != null && selectedBox.DriverId.HasValue && selectedBox.DriverId != currentEntry.DriverId)
            {
                await Swal.FireAsync("Erro", "Este box está ocupado por outro motorista e não pode ser atribuído.", "error");
                return;
            }
        }

        await VM.UpdateStatusAsync(movingEntryId.Value, movingStatusId);

        // 2) Atribui ou remove o box conforme seleção
        // Se tiver box selecionado, atribui; se não tiver, remove o box existente
        await VM.AssignBoxAsync(movingEntryId.Value, movingBoxId);
        
        if (!string.IsNullOrEmpty(VM.Error))
        {
            await Swal.FireAsync("Erro", VM.Error, "error");
            return;
        }

        // Recarrega boxes para atualizar status
        await VM.InitAsync();

        // Fecha o modal
        await CloseModal();

        // Recarrega a fila atual para refletir mudanças
        await VM.LoadQueueAsync();

        CancelMove();
        StateHasChanged();

        await Swal.FireAsync("Sucesso", "Movimentação realizada com sucesso.", "success");
    }

    private List<BoxDto> GetAvailableBoxes()
    {
        if (currentEntry == null)
            return VM.Boxes;

        // Retorna apenas boxes disponíveis:
        // - Boxes livres (DriverId == null)
        // - Box já atribuído ao mesmo motorista (DriverId == currentEntry.DriverId)
        // - Box atual do motorista (mesmo que esteja ocupado, se for do mesmo motorista)
        return VM.Boxes.Where(b => 
            !b.DriverId.HasValue || // Box livre
            b.DriverId == currentEntry.DriverId // Box já atribuído ao mesmo motorista
        ).ToList();
    }

    private async Task CloseModal()
    {
        // Usa JavaScript para fechar o modal do Bootstrap
        await JSRuntime.InvokeVoidAsync("eval", "var modal = bootstrap.Modal.getInstance(document.getElementById('moveModal')); if (modal) modal.hide();");
    }

    private bool IsTerminalStatus(int statusId)
    {
        var status = VM.Statuses.FirstOrDefault(s => s.Id == statusId);
        return status?.IsTerminal ?? false;
    }

    private async Task OnClearQueue()
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "Limpar fila",
            Text = "Tem certeza que deseja limpar a fila atual?",
            Icon = "warning",
            ShowCancelButton = true,
            ConfirmButtonText = "Sim, limpar",
            CancelButtonText = "Cancelar"
        });

        if (result.IsConfirmed)
        {
            await VM.ClearCurrentQueueAsync();

            if (string.IsNullOrEmpty(VM.Error))
            {
                await Swal.FireAsync("Sucesso", "Fila limpa com sucesso.", "success");
            }
            else
            {
                await Swal.FireAsync("Erro", VM.Error, "error");
            }

            StateHasChanged();
        }
    }

    private async Task OnStartBoxOperation(int queueEntryId)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "Iniciar operação",
            Text = "Deseja iniciar a operação no box?",
            Icon = "question",
            ShowCancelButton = true,
            ConfirmButtonText = "Sim, iniciar",
            CancelButtonText = "Cancelar"
        });

        if (result.IsConfirmed)
        {
            await VM.StartBoxOperationAsync(queueEntryId);
            await VM.LoadQueueAsync();

            if (string.IsNullOrEmpty(VM.Error))
            {
                await Swal.FireAsync("Sucesso", "Operação iniciada com sucesso.", "success");
            }
            else
            {
                await Swal.FireAsync("Erro", VM.Error, "error");
            }

            StateHasChanged();
        }
    }

    private async Task OnFinishBoxOperation(int queueEntryId)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "Finalizar operação",
            Text = "Deseja finalizar a operação no box? O motorista será removido da fila.",
            Icon = "warning",
            ShowCancelButton = true,
            ConfirmButtonText = "Sim, finalizar",
            CancelButtonText = "Cancelar"
        });

        if (result.IsConfirmed)
        {
            await VM.FinishBoxOperationAsync(queueEntryId);
            await VM.LoadQueueAsync();

            if (string.IsNullOrEmpty(VM.Error))
            {
                await Swal.FireAsync("Sucesso", "Operação finalizada com sucesso.", "success");
            }
            else
            {
                await Swal.FireAsync("Erro", VM.Error, "error");
            }

            StateHasChanged();
        }
    }
}
